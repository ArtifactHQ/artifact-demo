#!/usr/bin/env bash
# Quick test to verify the Docker image works

set -e

echo "ğŸ§ª Testing Rails 8 Template Docker Image..."
echo ""

# Random port to avoid conflicts
TEST_PORT=$((3000 + RANDOM % 1000))
CONTAINER_NAME="rails-test-$$"

echo "Starting test container on port $TEST_PORT..."
docker run --rm -d \
  -p "$TEST_PORT:3000" \
  --name "$CONTAINER_NAME" \
  rails8-template-dev:latest

# Wait for Rails to start
echo "Waiting for Rails to boot..."
for i in {1..30}; do
  if curl -sf "http://localhost:$TEST_PORT/up" > /dev/null 2>&1; then
    echo "âœ… Rails is responding!"
    break
  fi
  if [ $i -eq 30 ]; then
    echo "âŒ Rails failed to start within 30 seconds"
    docker logs "$CONTAINER_NAME"
    docker stop "$CONTAINER_NAME"
    exit 1
  fi
  sleep 1
done

# Test homepage
echo ""
echo "Testing homepage..."
if curl -sf "http://localhost:$TEST_PORT/" > /dev/null 2>&1; then
  echo "âœ… Homepage loads successfully!"
else
  echo "âŒ Homepage failed to load"
  docker logs "$CONTAINER_NAME"
  docker stop "$CONTAINER_NAME"
  exit 1
fi

# Test health check
echo ""
echo "Testing health check..."
if curl -sf "http://localhost:$TEST_PORT/up" > /dev/null 2>&1; then
  echo "âœ… Health check passes!"
else
  echo "âŒ Health check failed"
fi

echo ""
echo "ğŸ“Š Container stats:"
docker stats --no-stream "$CONTAINER_NAME"

echo ""
echo "ğŸ§¹ Cleaning up..."
docker stop "$CONTAINER_NAME"

echo ""
echo "âœ… All tests passed! Image is ready for use."
echo ""
echo "ğŸš€ Start a development session:"
echo "  ./bin/docker-start my-session"

